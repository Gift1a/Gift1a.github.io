<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gift1a.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="PE解析代码实现">
<meta property="og:type" content="article">
<meta property="og:title" content="PE解析代码实现">
<meta property="og:url" content="https://gift1a.github.io/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="PE解析代码实现">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-11T05:19:10.000Z">
<meta property="article:modified_time" content="2022-04-20T01:51:29.603Z">
<meta property="article:author" content="Gift1a">
<meta property="article:tag" content="PE">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://gift1a.github.io/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://gift1a.github.io/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/","path":"2022/03/11/PE解析代码实现/","title":"PE解析代码实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PE解析代码实现 | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%93%E5%8D%B0PE%E6%96%87%E4%BB%B6%E5%A4%B4%E9%83%A8%E5%92%8C%E8%8A%82%E5%8C%BA%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">打印PE文件头部和节区信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RVA%E8%BD%ACFOA"><span class="nav-number">2.</span> <span class="nav-text">RVA转FOA</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PE%E6%8F%92%E5%85%A5shellcode"><span class="nav-number">3.</span> <span class="nav-text">PE插入shellcode</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PE%E6%96%87%E4%BB%B6%E6%96%B0%E5%A2%9E%E8%8A%82"><span class="nav-number">4.</span> <span class="nav-text">PE文件新增节</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%AF%BC%E5%87%BA%E8%A1%A8%E4%BF%A1%E6%81%AF-%E6%8C%89%E5%90%8D%E7%A7%B0%E5%AF%BC%E5%87%BA"><span class="nav-number">5.</span> <span class="nav-text">打印导出表信息-按名称导出</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Gift1a"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Gift1a</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Gift1a" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gift1a" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://1.12.239.117:8090/" title="http:&#x2F;&#x2F;1.12.239.117:8090&#x2F;" rel="noopener" target="_blank">Fallw1nd</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://serionago.github.io/" title="https:&#x2F;&#x2F;serionago.github.io&#x2F;" rel="noopener" target="_blank">serion</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://equinox-shame.github.io/" title="https:&#x2F;&#x2F;equinox-shame.github.io&#x2F;" rel="noopener" target="_blank">梓曰</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gift1a.github.io/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Gift1a">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PE解析代码实现 | Hexo">
      <meta itemprop="description" content="PE解析代码实现">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PE解析代码实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-11 13:19:10" itemprop="dateCreated datePublished" datetime="2022-03-11T13:19:10+08:00">2022-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-20 09:51:29" itemprop="dateModified" datetime="2022-04-20T09:51:29+08:00">2022-04-20</time>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>22k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>20 分钟</span>
    </span>
</div>

            <div class="post-description">PE解析代码实现</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="打印PE文件头部和节区信息"><a href="#打印PE文件头部和节区信息" class="headerlink" title="打印PE文件头部和节区信息"></a>打印PE文件头部和节区信息</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//宏定义，方便后续使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义变量</span></span><br><span class="line">IMAGE_DOS_HEADER myDOS;</span><br><span class="line">LONG elf_new;</span><br><span class="line">IMAGE_NT_HEADERS32 myNTheader;</span><br><span class="line">IMAGE_OPTIONAL_HEADER32 myOPTIONheader;</span><br><span class="line">IMAGE_SECTION_HEADER mysection[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> NUM_SECTION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* pfile;</span><br><span class="line">	pfile = fopen(<span class="string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\notepad++.exe"</span>, <span class="string">"r"</span>);<span class="comment">//打开文件</span></span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_SET);<span class="comment">//参数说明，将fp指针从文件开头移动到0的位置</span></span><br><span class="line">	fread(&amp;myDOS, <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER), <span class="number">1</span>, pfile);<span class="comment">//表示从fp开始的地方读取一次长度为sizeof(IMAGE_DOS_HEADER)的字节，存储到myDOS中</span></span><br><span class="line">	<span class="comment">//DOS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"==============IMAGE_DOS_HEADER==============\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"DOS头：          %08X\n"</span>, myDOS.e_magic);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"NT头所在位置：   %08X\n"</span>, myDOS.e_lfanew);</span><br><span class="line">	elf_new = myDOS.e_lfanew;<span class="comment">//将NT头的偏移存储起来</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//NT头</span></span><br><span class="line">	fseek(pfile, elf_new, SEEK_SET);<span class="comment">//注意不是sizeof(elf_new)</span></span><br><span class="line">	fread(&amp;myNTheader, <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS), <span class="number">1</span>, pfile);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"==============IMAGE_NT_HEADERS==============\n"</span>);</span><br><span class="line">	<span class="comment">//打印PE标志</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"PE标志：         %08X\n"</span>, myNTheader.Signature);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印标准PE头信息</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"==============IMAGE_FILE_HEADERS==============\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"节区数量：       %08X\n"</span>, myNTheader.FileHeader.NumberOfSections);</span><br><span class="line">	NUM_SECTION = myNTheader.FileHeader.NumberOfSections;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"可选PE头大小：   %08X\n"</span>, myNTheader.FileHeader.SizeOfOptionalHeader);</span><br><span class="line">	<span class="comment">//打印ASLR的信息，方便查看和修改</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"ASLR属性：       %08X\n"</span>, (myNTheader.FileHeader.Characteristics ) &amp; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印可选PE头信息</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"==============IMAGE_OPTIONAL_HEADERS==============\n"</span>);</span><br><span class="line">	fseek(pfile, elf_new+<span class="keyword">sizeof</span>(IMAGE_FILE_HEADER)+<span class="keyword">sizeof</span>(myNTheader.Signature), SEEK_SET);<span class="comment">//因为标准PE头长度为20</span></span><br><span class="line">	fread(&amp;myOPTIONheader, <span class="keyword">sizeof</span>(IMAGE_OPTIONAL_HEADER), <span class="number">1</span>, pfile);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"DWORD AddressOfEntryPoint：   %08llX\n"</span>, myOPTIONheader.AddressOfEntryPoint);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"基址：				%08X\n"</span>, myOPTIONheader.ImageBase);<span class="comment">//注意这里的可选PE头类型必须是IMAGE_OPTIONAL_HEADER32</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"文件对齐大小：		%08X\n"</span>, myOPTIONheader.FileAlignment);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"内存对齐大小：		%08X\n"</span>, myOPTIONheader.SectionAlignment);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"文件头和节表大小：  %08X\n"</span>, myOPTIONheader.SizeOfHeaders);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"内存拉伸大小：		%08X\n"</span>, myOPTIONheader.SizeOfImage);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印节表信息，前面我们已经存储了节表数量了</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"==============IMAGE_SECTION_HEADER SectionHeaders==============\n"</span>);</span><br><span class="line">	fseek(pfile, elf_new + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS32), SEEK_SET);</span><br><span class="line">	fread(&amp;mysection, <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER) * NUM_SECTION, <span class="number">1</span>, pfile);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SECTION; ++i)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"NAME：        %s\n"</span>, mysection[i].Name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"DWORD VirtualAddress：        %08X\n"</span>, mysection[i].VirtualAddress);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"DWORD SizeOfRawData：        %08X\n"</span>, mysection[i].SizeOfRawData);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"DWORD PointerToRawData：        %08X\n"</span>, mysection[i].PointerToRawData);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"DWORD VirtualSize：        %08X\n"</span>, mysection[i].Misc.VirtualSize);</span><br><span class="line">	}</span><br><span class="line">	fclose(pfile);<span class="comment">//关闭文件</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="RVA转FOA"><a href="#RVA转FOA" class="headerlink" title="RVA转FOA"></a>RVA转FOA</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* RVA转FOA的思路</span></span><br><span class="line"><span class="comment">* 1、先判断所在节区，设计思路：首先我们必须拿的是内存对齐后的来比较大小，先把RVA-virtualaddress，再和max(MISC,SizeofRawData)按照内存对齐的值作比较</span></span><br><span class="line"><span class="comment">* 2、循环判断节区</span></span><br><span class="line"><span class="comment">* 3、计算FOA，偏移是一样的，那就是RVA-virtualaddress+节区的PointerOfdata</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">IMAGE_NT_HEADERS32 myNTheader;</span><br><span class="line">IMAGE_DOS_HEADER myDOS;<span class="comment">//因为PE头长度不变，所以我们只需要找到elf_new的内容就可以知道节区的起始地址</span></span><br><span class="line">IMAGE_SECTION_HEADER mysection[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">int</span> NUM_SECTION;<span class="comment">//我们还需要知道节区的数量</span></span><br><span class="line"><span class="keyword">int</span> elf_new;</span><br><span class="line"><span class="keyword">int</span> RVA = <span class="number">0x20d000</span>;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">MAX</span><span class="params">(DWORD a, DWORD b)</span></span></span><br><span class="line"><span class="function"></span>{<span class="comment">//计算MISC和SizeOFRAWDATA，并返回按照内存对齐后的值</span></span><br><span class="line">	<span class="keyword">if</span> (a &gt; b)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">return</span> (a%myNTheader.OptionalHeader.SectionAlignment)?((a / myNTheader.OptionalHeader.SectionAlignment)+<span class="number">1</span>) * myNTheader.OptionalHeader.SectionAlignment : ((a / myNTheader.OptionalHeader.SectionAlignment)) * myNTheader.OptionalHeader.SectionAlignment;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> (b % myNTheader.OptionalHeader.SectionAlignment) ? ((b / myNTheader.OptionalHeader.SectionAlignment) + <span class="number">1</span>) * myNTheader.OptionalHeader.SectionAlignment : ((b / myNTheader.OptionalHeader.SectionAlignment)) * myNTheader.OptionalHeader.SectionAlignment;;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* pfile;</span><br><span class="line">	pfile = fopen(<span class="string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\notepad++.exe"</span>, <span class="string">"r"</span>);</span><br><span class="line">	fseek(pfile,<span class="number">0</span>, SEEK_SET);</span><br><span class="line">	fread(&amp;myDOS, <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER), <span class="number">1</span>, pfile);</span><br><span class="line">	elf_new = myDOS.e_lfanew;</span><br><span class="line">	fseek(pfile, elf_new, SEEK_SET);</span><br><span class="line">	fread(&amp;myNTheader, <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS32), <span class="number">1</span>, pfile);</span><br><span class="line">	NUM_SECTION = myNTheader.FileHeader.NumberOfSections;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//得到节区</span></span><br><span class="line">	fseek(pfile, elf_new + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS32), SEEK_SET);</span><br><span class="line">	fread(&amp;mysection, <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER) * NUM_SECTION, <span class="number">1</span>, pfile);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SECTION; ++i)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span> (RVA - mysection[i].VirtualAddress &lt; MAX(mysection[i].Misc.VirtualSize, mysection[i].SizeOfRawData))</span><br><span class="line">		{</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"所在节区为：%s\n"</span>, mysection[i].Name);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"FOA为：%08X"</span>, RVA - mysection[i].VirtualAddress + mysection[i].PointerToRawData);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	fclose(pfile);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="PE插入shellcode"><a href="#PE插入shellcode" class="headerlink" title="PE插入shellcode"></a>PE插入shellcode</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MessageBoxA_ADDR 0x76C20F40<span class="comment">//MessageBoxA的地址</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> shellcode_len 0x12<span class="comment">//定义shellcode的长度</span></span></span><br><span class="line"><span class="comment">//输入路径和输出路径</span></span><br><span class="line"><span class="keyword">char</span> file_path[] = <span class="string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\notepad++.exe"</span>;</span><br><span class="line"><span class="keyword">char</span> final_path[] = <span class="string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\5.exe"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入的shellcode</span></span><br><span class="line">BYTE shellcode[] = {</span><br><span class="line">	<span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0xE8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0xE9</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">};</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LoadPE</span><span class="params">(LPVOID*pFileBuffer)</span><span class="comment">//二级指针存储的是一级指针的地址</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* pfile;</span><br><span class="line">	DWORD FileSize = <span class="number">0</span>;</span><br><span class="line">	LPVOID pTempBuffer;</span><br><span class="line">	pfile = fopen(file_path, <span class="string">"rb"</span>);</span><br><span class="line">	<span class="comment">//通过fseek和ftell返回文件长度，fseek将fp指针设置在文件尾，ftell获取当前fp指针的位置与文件首的偏移</span></span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">	FileSize = ftell(pfile);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//重新设置回开头</span></span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">	<span class="comment">//开辟空间，malloc函数返回开辟空间的起始地址</span></span><br><span class="line">	pTempBuffer = <span class="built_in">malloc</span>(FileSize);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将文件中的内容读取到临时Buffer中</span></span><br><span class="line">	fread(pTempBuffer, FileSize, <span class="number">1</span>, pfile);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将分配返回的地址存储到FileBuffer中</span></span><br><span class="line">	*pFileBuffer = pTempBuffer;</span><br><span class="line">	<span class="comment">//temp指针指向空</span></span><br><span class="line">	pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	fclose(pfile);</span><br><span class="line">	<span class="keyword">return</span> FileSize;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CopyFileBufferToImageBuffer</span><span class="params">(LPVOID pFileBuffer,LPVOID* pImageBuffer)</span><span class="comment">//pImageBuffer是void类型指针，指向的是读取到内存中的文件内容首地址</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">//初始化PE结构体指针</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDOSHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionalHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//初始化tempBuffer</span></span><br><span class="line">	LPVOID pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//通过强制转换类型来限制长度,转为Dos头的指针那么得到的就是Dos头的信息</span></span><br><span class="line">	pDOSHeader = PIMAGE_DOS_HEADER(pFileBuffer);</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDOSHeader-&gt;e_lfanew);<span class="comment">//因为void类型的指针不能直接运算，所以将其转为int整型，再做加减得到其他地址</span></span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader + <span class="number">4</span>);</span><br><span class="line">	pOptionalHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionalHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//分配ImageBuffer内存</span></span><br><span class="line">	pTempBuffer = <span class="built_in">malloc</span>(pOptionalHeader-&gt;SizeOfImage);</span><br><span class="line">	<span class="comment">//初始化ImageBuffer内存</span></span><br><span class="line">	<span class="built_in">memset</span>(pTempBuffer, <span class="number">0</span>, pOptionalHeader-&gt;SizeOfImage);</span><br><span class="line">	<span class="comment">//拷贝数据</span></span><br><span class="line">	<span class="built_in">memcpy</span>(pTempBuffer, pDOSHeader, pOptionalHeader-&gt;SizeOfHeaders);<span class="comment">//参数说明，目标数据、被使用数据，长度</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//循环拷贝节表信息</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pTempSectionHeader = pSectionHeader;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pFileHeader-&gt;NumberOfSections; i++,pTempSectionHeader++)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//因为memcpy只接受void类型的指针，所以要先强制转换</span></span><br><span class="line">		<span class="built_in">memcpy</span>((<span class="keyword">void</span>*)((DWORD)pTempBuffer + pTempSectionHeader-&gt;VirtualAddress), (<span class="keyword">void</span>*)((DWORD)pFileBuffer + pTempSectionHeader-&gt;PointerToRawData), pTempSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//赋值给pImageBuffer</span></span><br><span class="line">	*pImageBuffer = pTempBuffer;</span><br><span class="line">	pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> pOptionalHeader-&gt;SizeOfImage;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CopyImageBufferToNewBuffer</span><span class="params">(LPVOID pImageBuffer,LPVOID* pNewBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">//初始化PE结构体指针</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDOSHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionalHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//初始化TempBuffer</span></span><br><span class="line">	LPVOID pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//结构体强制转换</span></span><br><span class="line">	pDOSHeader = PIMAGE_DOS_HEADER(pImageBuffer);</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDOSHeader-&gt;e_lfanew);<span class="comment">//因为void类型的指针不能直接运算，所以将其转为int整型，再做加减得到其他地址</span></span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader + <span class="number">4</span>);</span><br><span class="line">	pOptionalHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionalHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算NewBuffer大小</span></span><br><span class="line">	DWORD new_buffer_size = pOptionalHeader-&gt;SizeOfHeaders;</span><br><span class="line">	<span class="comment">//节表大小计算</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pTempSectionHeader = pSectionHeader;</span><br><span class="line">	<span class="comment">//注意这里要使用临时变量，否则循环的时候，结构体指针后移，指向改变</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pFileHeader-&gt;NumberOfSections; i++, pTempSectionHeader++)</span><br><span class="line">	{</span><br><span class="line">		new_buffer_size += pTempSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">		<span class="comment">//printf("%X\n", pSectionHeader-&gt;SizeOfRawData);</span></span><br><span class="line">	}</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%X\n"</span>, new_buffer_size);</span><br><span class="line">	<span class="comment">//开辟空间并且设置为0</span></span><br><span class="line">	pTempBuffer = <span class="built_in">malloc</span>(new_buffer_size);</span><br><span class="line">	<span class="built_in">memset</span>(pTempBuffer, <span class="number">0</span>, new_buffer_size);</span><br><span class="line">	<span class="comment">//复制ImageBuffer信息</span></span><br><span class="line">	<span class="built_in">memcpy</span>(pTempBuffer, pDOSHeader, pOptionalHeader-&gt;SizeOfHeaders);</span><br><span class="line">	<span class="comment">//复制节表信息</span></span><br><span class="line">	pTempSectionHeader = pSectionHeader;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pFileHeader-&gt;NumberOfSections; i++, ++pTempSectionHeader)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//因为memcpy只接受void类型的指针，所以要先强制转换</span></span><br><span class="line">		<span class="built_in">memcpy</span>((PWORD)((DWORD)pTempBuffer + pTempSectionHeader-&gt;PointerToRawData), (PWORD)((DWORD)pImageBuffer + pTempSectionHeader-&gt;VirtualAddress), pTempSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//赋值给pImageBuffer</span></span><br><span class="line">	*pNewBuffer = pTempBuffer;</span><br><span class="line">	pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> new_buffer_size;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">newbuffer_write2_exe</span><span class="params">(PVOID NewFileBuffer, DWORD FileSize, <span class="keyword">char</span>* FilePath)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* fp1 = fopen(FilePath, <span class="string">"wb"</span>);</span><br><span class="line">	<span class="keyword">if</span> (fp1 != <span class="literal">NULL</span>)</span><br><span class="line">	{</span><br><span class="line">		fwrite(NewFileBuffer, FileSize, <span class="number">1</span>, fp1);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"成功存盘"</span>);</span><br><span class="line">	}</span><br><span class="line">	fclose(fp1);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ADD_Opcode</span><span class="params">(LPVOID pImageBuffer, LPVOID* pNewBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">//初始化PE结构体指针</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDOSHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionalHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//通过强制转换类型来限制长度,转为Dos头的指针那么得到的就是Dos头的信息</span></span><br><span class="line">	pDOSHeader = PIMAGE_DOS_HEADER(pImageBuffer);</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDOSHeader-&gt;e_lfanew);<span class="comment">//因为void类型的指针不能直接运算，所以将其转为int整型，再做加减得到其他地址</span></span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader + <span class="number">4</span>);</span><br><span class="line">	pOptionalHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionalHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">	<span class="comment">//判断能否插入</span></span><br><span class="line">	<span class="keyword">if</span> (shellcode_len &gt; pSectionHeader-&gt;SizeOfRawData - pSectionHeader-&gt;Misc.VirtualSize)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"长度不足，无法插入\n"</span>);</span><br><span class="line">		<span class="built_in">free</span>(pImageBuffer);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算空白位置，转为char*指针</span></span><br><span class="line">	PBYTE code_begin = (PBYTE)((DWORD)pImageBuffer + pSectionHeader-&gt;VirtualAddress+ pSectionHeader-&gt;Misc.VirtualSize);</span><br><span class="line">	<span class="comment">//插入shellcode</span></span><br><span class="line">	<span class="built_in">memcpy</span>(code_begin, shellcode, shellcode_len);</span><br><span class="line">	<span class="comment">//计算E8地址</span></span><br><span class="line">	DWORD callADDr = (MessageBoxA_ADDR - (pOptionalHeader-&gt;ImageBase + pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize + <span class="number">0xD</span>));</span><br><span class="line">	<span class="comment">//将callADDR插入到E8之后,填充数据</span></span><br><span class="line">	*(PDWORD)((DWORD)code_begin + <span class="number">0x09</span>) = callADDr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算jmp地址,跳转的值=真实地址-下一条指令地址</span></span><br><span class="line">	DWORD jmpADDr = pOptionalHeader-&gt;ImageBase + pOptionalHeader-&gt;AddressOfEntryPoint - ((DWORD)code_begin + pOptionalHeader-&gt;ImageBase + shellcode_len-(DWORD)pImageBuffer);</span><br><span class="line">	*(PDWORD)((code_begin + <span class="number">14</span>)) = jmpADDr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//修改OEP</span></span><br><span class="line">	pOptionalHeader-&gt;AddressOfEntryPoint = ((DWORD)code_begin - (DWORD)pImageBuffer);<span class="comment">//也可以使用VirtualAddress+VirtualSize</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//还原为NewBuffer</span></span><br><span class="line">	DWORD ret2=CopyImageBufferToNewBuffer(pImageBuffer, pNewBuffer);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//存盘</span></span><br><span class="line">	newbuffer_write2_exe(*pNewBuffer,ret2, final_path);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">operate_pe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	LPVOID pFileBuffer = <span class="literal">NULL</span>;<span class="comment">//LPVOID相当于void*</span></span><br><span class="line">	LPVOID pNewBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	LPVOID pImageBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//读取文件内容到FileBuffer中d</span></span><br><span class="line">	DWORD file_size = LoadPE(&amp;pFileBuffer);<span class="comment">//二级指针void**,将存储指针的地址传过去</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"文件长度为：  %08X\n"</span>, file_size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将FileBuffer拉伸为ImageBuffer</span></span><br><span class="line">	DWORD Image_Size = CopyFileBufferToImageBuffer(pFileBuffer,&amp;pImageBuffer);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"拉伸后的大小为：  %08X\n"</span>,Image_Size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//添加opcode</span></span><br><span class="line">	ADD_Opcode(pImageBuffer, &amp;pNewBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//开辟的内存需要free掉</span></span><br><span class="line">	<span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">	<span class="built_in">free</span>(pNewBuffer);</span><br><span class="line">	<span class="built_in">free</span>(pImageBuffer);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	operate_pe();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="PE文件新增节"><a href="#PE文件新增节" class="headerlink" title="PE文件新增节"></a>PE文件新增节</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">思路：</span></span><br><span class="line"><span class="comment">1、读取文件信息到buffer中</span></span><br><span class="line"><span class="comment">判断节区信息够不够大小，两个节表的大小</span></span><br><span class="line"><span class="comment">2、找到节区的最后位置，开辟指定大小的空间</span></span><br><span class="line"><span class="comment">3、修改信息-NumberOfSection、SizeOfRawData、VirtualSize（注意要对齐）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> New_Buffer_Size 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> File_Path <span class="meta-string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\notepad++.exe"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Final_Path <span class="meta-string">"D:\\new\\Notepadx32\\Notepad++.7.6.1.bin.x32\\Notepad++.7.6.1.bin.x32\\6++.exe"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Open_File</span><span class="params">(LPVOID *pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* pfile = <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	LPVOID TempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	pfile = fopen(File_Path, <span class="string">"rb"</span>);</span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">	DWORD file_size = ftell(pfile);</span><br><span class="line">	<span class="comment">//设置文件指针到文件头</span></span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">	TempBuffer = <span class="built_in">malloc</span>(file_size);</span><br><span class="line">	fread(TempBuffer , file_size, <span class="number">1</span>, pfile);</span><br><span class="line">	</span><br><span class="line">	*pFileBuffer = TempBuffer;</span><br><span class="line">	TempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	fclose(pfile);</span><br><span class="line">	<span class="keyword">return</span> file_size;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Add_Section</span><span class="params">(LPVOID FileBuffer, LPVOID* pNewBuffer,DWORD file_size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">//定义结构体指针</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDOSHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS32 pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionalHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSection = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PVOID pNewTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD New_File_Size = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//新增节</span></span><br><span class="line">	New_File_Size = file_size + <span class="number">0x1000</span>;</span><br><span class="line">	pNewTempBuffer = (PVOID)<span class="built_in">malloc</span>(New_File_Size);</span><br><span class="line">	<span class="comment">// 判断开辟空间是否成功</span></span><br><span class="line">	<span class="keyword">if</span> (!pNewTempBuffer)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"pNewTempBuffer开辟空间失败!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 初始化内存</span></span><br><span class="line">	<span class="built_in">memset</span>(pNewTempBuffer, <span class="number">0</span>, New_File_Size);</span><br><span class="line">	<span class="comment">// 将旧空间的内容copy到新的空间</span></span><br><span class="line">	<span class="built_in">memcpy</span>(pNewTempBuffer, FileBuffer, file_size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//读取信息</span></span><br><span class="line">	pDOSHeader = (PIMAGE_DOS_HEADER)(pNewTempBuffer);</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS32)((DWORD)pNewTempBuffer + pDOSHeader-&gt;e_lfanew);</span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader + <span class="number">4</span>);</span><br><span class="line">	pOptionalHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER));</span><br><span class="line">	pSection = (PIMAGE_SECTION_HEADER)((DWORD)pOptionalHeader + <span class="keyword">sizeof</span>(IMAGE_OPTIONAL_HEADER32));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//找到节表的最后位置</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pfinal_Section = &amp;(pSection[pFileHeader-&gt;NumberOfSections - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断能否插入节表,因为在文件和内存中PE头和DOS头大小不变，直接计算即可</span></span><br><span class="line">	DWORD remain_size = (pOptionalHeader-&gt;SizeOfHeaders - pDOSHeader-&gt;e_lfanew - <span class="number">4</span> - <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) - <span class="keyword">sizeof</span>(IMAGE_OPTIONAL_HEADER32) - <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER) * pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	<span class="keyword">if</span> (remain_size &lt; <span class="number">2</span> * <span class="keyword">sizeof</span>(IMAGE_SECTION_HEADER))</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"位置不够捏，想想其他办法吧~\n"</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//修改信息</span></span><br><span class="line">	<span class="comment">// 初始化新增节信息</span></span><br><span class="line">	PVOID pSecName = &amp;pSection[pFileHeader-&gt;NumberOfSections].Name;</span><br><span class="line">	PDWORD pSecMisc = &amp;pSection[pFileHeader-&gt;NumberOfSections].Misc.VirtualSize;</span><br><span class="line">	PDWORD pSecVirtualAddress = &amp;pSection[pFileHeader-&gt;NumberOfSections].VirtualAddress;</span><br><span class="line">	PDWORD pSecSizeofRawData = &amp;pSection[pFileHeader-&gt;NumberOfSections].SizeOfRawData;</span><br><span class="line">	PDWORD pSecPointerToRawData = &amp;pSection[pFileHeader-&gt;NumberOfSections].PointerToRawData;</span><br><span class="line">	PDWORD pSecCharacteristic = &amp;pSection[pFileHeader-&gt;NumberOfSections].Characteristics;</span><br><span class="line">	<span class="comment">//名字</span></span><br><span class="line">	<span class="built_in">memcpy</span>(pSecName, <span class="string">".mycode"</span>, <span class="number">8</span>);</span><br><span class="line">	<span class="comment">//Misc</span></span><br><span class="line">	*pSecMisc = <span class="number">0x1000</span>;</span><br><span class="line">	<span class="comment">//计算VirtualAddress=前一个节的VA+sizeofrawdata或者virtualSize内存对齐大小</span></span><br><span class="line">	DWORD Sec_Size = (pfinal_Section-&gt;SizeOfRawData &gt; pfinal_Section-&gt;Misc.VirtualSize) ? pfinal_Section-&gt;SizeOfRawData : pfinal_Section-&gt;Misc.VirtualSize;</span><br><span class="line">	<span class="comment">//内存对齐</span></span><br><span class="line">	Sec_Size= (Sec_Size % pOptionalHeader-&gt;SectionAlignment) ? ((Sec_Size / pOptionalHeader-&gt;SectionAlignment) + <span class="number">1</span>) * pOptionalHeader-&gt;SectionAlignment : Sec_Size;</span><br><span class="line">	<span class="comment">//修改VirtualAddress</span></span><br><span class="line">	*pSecVirtualAddress = pfinal_Section-&gt;VirtualAddress + Sec_Size;</span><br><span class="line">	<span class="comment">//修改sizeofRawData</span></span><br><span class="line">	*pSecSizeofRawData = <span class="number">0x1000</span>;</span><br><span class="line">	<span class="comment">//修改Pointer</span></span><br><span class="line">	DWORD size = pfinal_Section-&gt;SizeOfRawData;</span><br><span class="line">	DWORD File_Size= (size % pOptionalHeader-&gt;FileAlignment) ? ((size / pOptionalHeader-&gt;FileAlignment) + <span class="number">1</span>) * pOptionalHeader-&gt;FileAlignment : size;</span><br><span class="line">	*pSecPointerToRawData = pfinal_Section-&gt;PointerToRawData + File_Size;</span><br><span class="line"></span><br><span class="line">	*pSecCharacteristic = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//头部信息,先计算增加的长度在内存和文件拉伸的长度</span></span><br><span class="line">	DWORD Sec_ADD = (New_Buffer_Size % pOptionalHeader-&gt;SectionAlignment) ? ((New_Buffer_Size / pOptionalHeader-&gt;SectionAlignment) + <span class="number">1</span>) * pOptionalHeader-&gt;SectionAlignment : New_Buffer_Size;</span><br><span class="line">	DWORD File_ADD = </span><br><span class="line">	pOptionalHeader-&gt;SizeOfImage += Sec_ADD;</span><br><span class="line">	pFileHeader-&gt;NumberOfSections += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	*pNewBuffer = pNewTempBuffer;</span><br><span class="line">	pNewTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> New_File_Size;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Write_To_Newfile</span><span class="params">(DWORD New_File_Size, LPVOID pNewBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE* fp;</span><br><span class="line">	fp = fopen(Final_Path, <span class="string">"wb"</span>);</span><br><span class="line">	fwrite(pNewBuffer, New_File_Size, <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PE_operate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	DWORD new_file_size = <span class="number">0</span>;</span><br><span class="line">	PVOID pNewBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	PVOID FileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD file_size = <span class="number">0</span>;</span><br><span class="line">	DWORD New_File_Size = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//打开文件读取信息</span></span><br><span class="line">	file_size = Open_File(&amp;FileBuffer);</span><br><span class="line">	<span class="comment">//新增节并且修改信息</span></span><br><span class="line">	New_File_Size=Add_Section(FileBuffer,&amp;pNewBuffer,file_size);</span><br><span class="line"></span><br><span class="line">	Write_To_Newfile(New_File_Size, pNewBuffer);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	PE_operate();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="打印导出表信息-按名称导出"><a href="#打印导出表信息-按名称导出" class="headerlink" title="打印导出表信息-按名称导出"></a>打印导出表信息-按名称导出</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FilePath <span class="meta-string">"D:\\OneDrive\\桌面\\reverse\\吾爱破解专用版Ollydbg\\DBGHELP.DLL"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReadFileToBuffer</span><span class="params">(LPVOID *FileBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	LPVOID pTempBuffer;</span><br><span class="line">	<span class="comment">//打开文件并读取到Buffer中</span></span><br><span class="line">	FILE* pfile = <span class="literal">NULL</span>;</span><br><span class="line">	pfile = fopen(FilePath, <span class="string">"r"</span>);</span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">	<span class="comment">//读取文件大小</span></span><br><span class="line">	DWORD file_size = ftell(pfile);</span><br><span class="line">	<span class="comment">//设置到开头进行读取</span></span><br><span class="line">	fseek(pfile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">	<span class="comment">//先开辟空间</span></span><br><span class="line">	pTempBuffer = (<span class="keyword">void</span>*)<span class="built_in">malloc</span>(file_size);</span><br><span class="line">	<span class="comment">//读取信息</span></span><br><span class="line">	fread(pTempBuffer, file_size, <span class="number">1</span>, pfile);</span><br><span class="line">	<span class="comment">//如果是一级指针，读取完之后就会被释放掉</span></span><br><span class="line">	*FileBuffer = pTempBuffer;</span><br><span class="line">	pTempBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	fclose(pfile);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* RVA转FOA</span></span><br><span class="line"><span class="comment">* 先看在哪个节区，减去该节区的RVA+该节区的PointerOfRawData</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">DWORD <span class="title">RVATOFOA</span><span class="params">(PIMAGE_SECTION_HEADER pSectionHeader, DWORD RVA,DWORD NumberOfSection)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	DWORD FOA = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumberOfSection; i++, pSectionHeader++)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//如果小于RVA+节区的大小，说明在节区内</span></span><br><span class="line">		<span class="keyword">if</span> (RVA &lt; pSectionHeader-&gt;VirtualAddress + max(pSectionHeader-&gt;SizeOfRawData, pSectionHeader-&gt;Misc.VirtualSize))</span><br><span class="line">		{</span><br><span class="line">			FOA = RVA - pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;PointerToRawData;</span><br><span class="line">			<span class="keyword">return</span> FOA;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintExportTable</span><span class="params">(LPVOID FileBuffer)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS32 pNtHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionalHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_EXPORT_DIRECTORY pExportTable = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_DATA_DIRECTORY pDataTable= <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//读取DLL信息</span></span><br><span class="line">	pDosHeader = (PIMAGE_DOS_HEADER)(FileBuffer);</span><br><span class="line">	pNtHeader = (PIMAGE_NT_HEADERS32)((DWORD)FileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNtHeader + <span class="number">4</span>);</span><br><span class="line">	pOptionalHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER));</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionalHeader + <span class="keyword">sizeof</span>(IMAGE_OPTIONAL_HEADER32));</span><br><span class="line">	<span class="comment">//获取导出表基本信息</span></span><br><span class="line">	pDataTable = (PIMAGE_DATA_DIRECTORY)(pOptionalHeader-&gt;DataDirectory);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"导出表的RVA为：%X\n"</span>, pDataTable[<span class="number">0</span>].VirtualAddress);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"导出表的大小为：%X\n"</span>, pDataTable[<span class="number">0</span>].Size);</span><br><span class="line">	<span class="comment">//打印导出表</span></span><br><span class="line">	DWORD ExportTable_FOA = RVATOFOA(pSectionHeader, pDataTable[<span class="number">0</span>].VirtualAddress,pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"导出表在文件中的位置为：%X\n"</span>, ExportTable_FOA);</span><br><span class="line">	<span class="comment">//获取导出表信息</span></span><br><span class="line">	pExportTable = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pDosHeader + ExportTable_FOA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印导出表信息，获取DLL名称，导出函数名称表，导出函数地址表，导出函数序号表</span></span><br><span class="line">	<span class="comment">//先打印导出表按名字导出函数的个数</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"按名称导出的函数个数为：%X\n"</span>, pExportTable-&gt;NumberOfFunctions);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"按名称导出的函数个数为：%X\n"</span>, pExportTable-&gt;NumberOfNames);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印DLL名称，导出函数名称表，导出函数地址表，导出函数序号表</span></span><br><span class="line">	DWORD NameFOA = RVATOFOA(pSectionHeader, pExportTable-&gt;Name, pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	<span class="keyword">char</span>* nameofdll = (<span class="keyword">char</span>*)((DWORD)pDosHeader + NameFOA);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"DLL的名称为：%s\n"</span>, nameofdll);</span><br><span class="line">	DWORD FOAOfName= RVATOFOA(pSectionHeader,pExportTable-&gt;AddressOfNames, pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	DWORD FOAOfNameOdinals= RVATOFOA(pSectionHeader, pExportTable-&gt;AddressOfNameOrdinals, pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	DWORD FOAOfFunctions= RVATOFOA(pSectionHeader, pExportTable-&gt;AddressOfFunctions, pFileHeader-&gt;NumberOfSections);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"文件中导出函数地址表为：%X\n文件中函数名称地址表为：%X\n文件中函数序号地址表为：%X\n"</span>, FOAOfFunctions, FOAOfName, FOAOfNameOdinals);</span><br><span class="line">	<span class="keyword">int</span> * FuncTable = (<span class="keyword">int</span>*)((DWORD)pDosHeader + FOAOfFunctions);</span><br><span class="line">	<span class="keyword">int</span>* NameTable = (<span class="keyword">int</span>*)((DWORD)pDosHeader + FOAOfName);</span><br><span class="line">	<span class="keyword">short</span>* Ordinals = (<span class="keyword">short</span>*)((DWORD)pDosHeader + FOAOfNameOdinals);</span><br><span class="line"></span><br><span class="line">	<span class="comment">////注意下面是随机打印的</span></span><br><span class="line">	<span class="comment">//for(int i = 0; i &lt; pExportTable-&gt;NumberOfNames; ++i)</span></span><br><span class="line">	<span class="comment">//{</span></span><br><span class="line">	<span class="comment">//	printf("导出函数地址为：%X ", RVATOFOA(pSectionHeader, *FuncTable, pFileHeader-&gt;NumberOfSections));</span></span><br><span class="line">	<span class="comment">//	</span></span><br><span class="line">	<span class="comment">//	char*name=(char*)pDosHeader + (RVATOFOA(pSectionHeader, *NameTable, pFileHeader-&gt;NumberOfSections));</span></span><br><span class="line">	<span class="comment">//	printf("名称为：%s ", name);</span></span><br><span class="line">	<span class="comment">//	//函数序号存储的不是RVA，而是序号,直接解引用即可，但是要注意是short型</span></span><br><span class="line">	<span class="comment">//	printf("函数序号为：%X\n", *Ordinals);</span></span><br><span class="line">	<span class="comment">//	NameTable++;</span></span><br><span class="line">	<span class="comment">//	FuncTable++;</span></span><br><span class="line">	<span class="comment">//	Ordinals++;</span></span><br><span class="line">	<span class="comment">//}</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//按函数名称导出</span></span><br><span class="line">	<span class="keyword">char</span> funcname[] = <span class="string">"WinDbgExtensionDllInit"</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pExportTable-&gt;NumberOfNames; ++i)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">char</span>* name = (<span class="keyword">char</span>*)pDosHeader + (RVATOFOA(pSectionHeader, *NameTable, pFileHeader-&gt;NumberOfSections));</span><br><span class="line">		<span class="comment">//printf("函数名称为：%s\n", name);</span></span><br><span class="line">		<span class="comment">//如果找到我们的函数名时，先把下标去序号表找，然后取出里面的值，再拿去函数地址表找</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(funcname, name) == <span class="number">0</span>)</span><br><span class="line">		{</span><br><span class="line">			Ordinals += i;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"函数名称为：%s\n"</span>, name);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"函数序号为：%X\n"</span>, *Ordinals);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"导出函数地址为：%X "</span>, RVATOFOA(pSectionHeader, *(FuncTable+*Ordinals), pFileHeader-&gt;NumberOfSections));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span><span class="comment">//否则就是按照序号导出的，只需要将</span></span><br><span class="line">		{</span><br><span class="line"></span><br><span class="line">		}</span><br><span class="line">		NameTable++;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oprate_pe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	LPVOID FileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	ReadFileToBuffer(&amp;FileBuffer);</span><br><span class="line">	PrintExportTable(FileBuffer);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	oprate_pe();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PE/" rel="tag"># PE</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/03/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" rel="prev" title="PE文件结构">
                  <i class="fa fa-chevron-left"></i> PE文件结构
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/11/PE-%E6%BB%B4%E6%B0%B4%E9%80%86%E5%90%91-%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0/" rel="next" title="PE-滴水逆向-手动实现">
                  PE-滴水逆向-手动实现 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gift1a</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">273k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:09</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






<script class="next-config" data-name="valine" type="application/json">{"enable":true,"appId":"GhjDb9gbtgwnrtsySW3fcGac-MdYXbMMI","appKey":"0Qw5kecTryGX5eSrEvShaWPw","serverURLs":"https://ghjdb9gb.api.lncldglobal.com","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":"false# Article reading statistic","comment_count":true,"recordIP":true,"enableQQ":true,"requiredFields":[],"el":"#valine-comments","path":"/2022/03/11/PE%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0/"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.valine.el)
    .then(() => NexT.utils.getScript(
      'https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js',
      { condition: window.Valine }
    ))
    .then(() => {
      new Valine(CONFIG.valine);
    });
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>
